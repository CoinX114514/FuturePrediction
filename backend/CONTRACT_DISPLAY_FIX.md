# 合约官网不显示问题修复说明

## 问题现象

I2603 铁矿石在导出的 Markdown 中有数据，但官网不显示。

## 原因分析

1. **同步时被日线过滤掉**  
   同步脚本原先只保留「在 Tushare 当日 `fut_daily` 里有行情」的合约。  
   `fut_daily` 有返回条数限制（如约 1000 条），超出部分的合约会被误删，导致 I2603 等未进入数据库，官网自然没有。

2. **单字母品种交易所推断错误**  
   价格/K 线服务里用 `contract_code[:2]` 取「品种」：  
   - I2603 → 取到 "I2" 而不是 "I"  
   - 交易所映射里没有 "I2"，被当成默认 SHFE，生成 `I2603.SHF`  
   - 铁矿石在大商所，正确应为 `I2603.DCE`  
   结果查价/查 K 线失败，前端可能不展示或显示「无数据」。

## 已做修改

### 1. 同步脚本 `sync_tushare_futures_to_db.py`

- **不再用日线过滤**  
  只按 `fut_basic` 的上市/退市日期判断是否「正在交易」，所有符合条件的合约都会写入数据库。  
  日线数据仅用来给 `current_price` 赋值，不再用来删合约。
- 效果：I2603 及原先被日线条数限制挡掉的合约都会进库并在官网列表里出现。

### 2. Tushare 服务 `app/services/tushare_service.py`

- **品种提取**  
  用正则 `^([A-Za-z]+)` 从合约代码里只取字母部分：  
  - I2603 → "I"  
  - CU2601 → "CU"  
  - SS2606 → "SS"
- **品种 → 交易所后缀映射**  
  补全单字母及常见品种的交易所后缀，例如：  
  - I → DCE（铁矿石）  
  - C, A, M, Y, P, L, V, J, T 等 → 对应 DCE/CZCE/CFFEX  
  这样 I2603 会正确转为 `I2603.DCE`，价格和 K 线能查到。
- **get_futures_price**  
  内部统一调用 `convert_contract_code_to_ts_code(contract_code)` 得到 ts_code，不再用旧的 `contract_code[:2]` 逻辑。

## 可能受影响的品种（单字母易被误判）

以下品种若之前被当成「默认 SHFE」就会查错交易所，现已按正确交易所映射：

| 品种代码 | 名称   | 正确交易所 | 原误判 |
|----------|--------|------------|--------|
| I        | 铁矿石 | DCE        | SHF    |
| C        | 玉米   | DCE        | SHF    |
| A        | 豆一   | DCE        | SHF    |
| M        | 豆粕   | DCE        | SHF    |
| Y        | 豆油   | DCE        | SHF    |
| P        | 棕榈油 | DCE        | SHF    |
| L        | 塑料   | DCE        | SHF    |
| V        | PVC    | DCE        | SHF    |
| J        | 焦炭   | DCE        | SHF    |
| T        | 10年期国债 | CFFEX  | 已正确 CFX |

多字母但易混淆的也已纳入映射（如 IF/IH/IC/IM、TS/TF/TL、RB、HC、SS 等）。

## 建议操作

1. **重新同步合约与帖子**  
   在项目根目录执行：  
   `python sync_tushare_futures_to_db.py`  
   确保 I2603 等所有活跃合约都进库。
2. **刷新官网**  
   首页/列表页应能看到 I2603 铁矿石；搜索「I2603」或「铁矿石」也可验证。
3. **验证价格与 K 线**  
   打开 I2603 详情页，确认当前价和 K 线能正常显示（说明 ts_code 已为 I2603.DCE）。

## 如何自查是否还有漏掉

- 用导出的 Markdown/CSV 里某一合约代码在官网搜索，若搜不到 → 可能仍未进库，再跑一次同步。  
- 若合约在列表里但「无价格/无 K 线」→ 多半是交易所错误，可在 `tushare_service.py` 的 `SYMBOL_EXCHANGE_SUFFIX` 里补上该品种对应交易所后缀。
